#1.  Provide the list of markets in which customer  "Atliq  Exclusive"  operates its business in the  APAC  region.
select distinct market
from dim_customer
where customer="Atliq Exclusive" and region="APAC";

#2. What is the percentage of unique product increase in 2021 vs. 2020? The 
#final output contains these fields, 
#unique_products_2020 
#unique_products_2021 
#percentage_chg
with 
cte1 as 
(select count(distinct product_code) as unique_product_2020
from fact_sales_monthly
where fiscal_year="2020"), 
cte2 as
(select count(distinct product_code) as unique_product_2021
from fact_sales_monthly
where fiscal_year="2021")
select *, Round((unique_product_2021 - unique_product_2020)*100/unique_product_2020,2) as percentage_chg from 
cte1 
cross join cte2;

#3 Provide a report with all the unique product counts for each  segment  and 
#sort them in descending order of product counts. The final output contains 
#2 fields, 
#segment 
#product_count 
select segment, count(distinct product_code) as product_count
from dim_product 
group by segment
order by product_count desc;

#4.  Follow-up: Which segment had the most increase in unique products in 
#2021 vs 2020? The final output contains these fields, 
#segment 
#product_count_2020 
#product_count_2021 
#difference 
with cte1 as 
(select p.segment as segment, count(distinct p.product_code) as product_count_2020
from fact_sales_monthly fs
join dim_product p
on 
fs.product_code=p.product_code
where fs.fiscal_year = "2020"
group by p.segment
order by product_count_2020 desc),
cte2 as 
(select p.segment as segment, count(distinct p.product_code) as product_count_2021
from fact_sales_monthly fs
join dim_product p
on 
fs.product_code=p.product_code
where fs.fiscal_year = "2021"
group by p.segment
order by product_count_2021 desc)
select cte1.segment, cte1.product_count_2020, cte2.product_count_2021, abs((product_count_2020-product_count_2021)) as difference
from cte1 
join cte2 on cte1.segment=cte2.segment
order by difference desc;


#5  Get the products that have the highest and lowest manufacturing costs. 
#The final output should contain these fields, 
#product_code 
#product 
#manufacturing_cost
SELECT 
    d.product_code,
    d.product,
    f.manufacturing_cost
FROM 
    fact_manufacturing_cost f
JOIN 
    dim_product d ON f.product_code = d.product_code
WHERE 
    f.manufacturing_cost = (SELECT MAX(manufacturing_cost) FROM fact_manufacturing_cost)
    OR
    f.manufacturing_cost = (SELECT MIN(manufacturing_cost) FROM fact_manufacturing_cost);
    
    
#request 6
select c.customer_code, c.customer, round(avg(pre_invoice_discount_pct),4) as average_discount_percentage
from fact_pre_invoice_deductions fp
join dim_customer c
on fp.customer_code=c.customer_code
where market="India" and fiscal_year="2021"
group by customer_code, customer
order by average_discount_percentage desc limit 5;

#request7
select MONTHNAME(fs.date) AS extracted_month, YEAR(fs.date) AS extracted_year, round(sum((fs.sold_quantity*fg.gross_price)),2) as gross_sales
from fact_sales_monthly fs 
join fact_gross_price fg 
using (product_code)
join dim_customer c 
using (customer_code)
where customer = "Atliq Exclusive"
group by (fs.date)
order by extracted_year desc;

#request8
SELECT
    CASE
        WHEN MONTH(date) IN (9, 10, 11) THEN "Q1"
        WHEN MONTH(date) IN (12, 1, 2) THEN "Q2"
        WHEN MONTH(date) IN (3, 4, 5) THEN "Q3"
        ELSE "Q4"
    END AS Quarter,
    sum(sold_quantity) as total_sold_quantity
FROM
    fact_sales_monthly
    where fiscal_year = "2020"
    group by Quarter
    order by total_sold_quantity desc;
    
    #request9
    with cte1 as 
    (select c.channel, round(sum((fs.sold_quantity*fg.gross_price)),2) as gross_sales_mln 
    from fact_sales_monthly fs
    join dim_customer c 
    on fs.customer_code=c.customer_code
    join fact_gross_price fg
    on fs.product_code=fg.product_code
    where fs.fiscal_year="2021"
    group by c.channel
    order by gross_sales_mln desc)
    select * , gross_sales_mln*100/sum(gross_sales_mln) over()  as percentage
    from cte1;

#request10
with cte1 as 
(select  p.division , p.product_code, p.product,
sum(fs.sold_quantity) as total_sold_quantity
from fact_sales_monthly fs 
join dim_product p 
using(product_code)
where fs.fiscal_year=2021
group by p.division , p.product_code, p.product),
cte2 as (select *, 
dense_rank() over(partition by division order by total_sold_quantity desc) as rank_order
from cte1)
select * from cte2 
where rank_order<=3;




 

